{
    "contents" : "---\nlayout: default\ntitle: \"Survey\"\nauthor: \"Markus Kainu\"\ndate: \"05.09.2014\"\n---\n\n\n# Survey\n\n**Resources**\n\n- [survey: analysis of complex survey samples in CRAN](http://cran.r-project.org/web/packages/survey/index.html)\n- [Thomas Lumley: Survey analysis in R](http://faculty.washington.edu/tlumley/survey/)\n\n\nThese analysis have been made using [Life in Transition Survey 2](http://www.ebrd.com/pages/research/publications/special/transitionII.shtml). You can load the data in R with following line of code\n\n```{rload, cache=TRUE, warning=FALSE, message=FALSE}\nlibrary(foreign)\ntemp <- tempfile()\ndownload.file(\"http://www.ebrd.com/downloads/research/surveys/lits2.dta\", temp)\nlits2 <- read.dta(temp)\n```\n\n\n\n## Survey design\n\n```{rdesign, warning=FALSE, message=FALSE, cache=TRUE}\nlibrary(survey)\nd.df <- svydesign(id = ~SerialID, \n                  weights = ~weight, \n                  data = lits2)\n```\n\n\n## Plotting distributions\n\n```{rplot_dist, cache=TRUE}\ndpar <- par(mfrow=c(1,2))\nsvyhist(~q104a_1, design=d.df, \n        main=\"Survey weighted\",\n        col=\"cadetblue\")\nlines(svysmooth(~q104a_1, d.df, bandwidth=5))\nhist(lits2$q104a_1,  main=\"Sample unweighted\",\n     col=\"cadetblue\",prob=TRUE)\nlines(density(lits2$q104a_1, adjust=2))\npar(dpar)\n```\n\n## Statistical tables \n\n### Mean Age by country with standard errors\n\n```{rmean, warning=FALSE, message=FALSE, cache=TRUE}\n# Create a data.frame out of table\nt <- data.frame(svyby(~q104a_1, ~q102_1+country, design=d.df, svymean, na.rm=T))\n# New names for data file\nnames(t) <- c(\"Sex\",\"Country\",\"mean_age\",\"SE\")\n# Reorder the columns\nt <- t[c(2,1,3,4)]\n```\n\n### GRAPH with Errorbars\n\n```{rmeanplot, warning=FALSE, message=FALSE, cache=TRUE}\nlibrary(ggplot2)\nggplot(t, aes(x=Country, y=mean_age, fill=Sex)) +\n  geom_bar(position=\"dodge\", stat=\"identity\") +\n  geom_errorbar(aes(ymin=mean_age-SE, ymax=mean_age+SE), width=.2,\n                position=position_dodge(.9)) +\n  coord_cartesian(ylim=c(35,65)) +\n  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))\n```\n\n\n## Quantities by categorical variable\n\nLet's use variable **q301a**\n\n>The economic situation in our country is better today than around 4 years ago\n\n```{rquant_plot, warning=FALSE, message=FALSE, cache=TRUE}\n# manipulate string\nlibrary(stringr)\nlits2$q301a <- as.factor(str_replace(lits2$q301a, \"Don't know\", \"Dont know\"))\n# recode\nlits2$q301a_rec[lits2$q301a == \"Strongly agree\"] <- \"Agree\"\nlits2$q301a_rec[lits2$q301a == \"Agree\"] <- \"Agree\"\nlits2$q301a_rec[lits2$q301a == \"Strongly disagree\"] <- \"Disagree\"\nlits2$q301a_rec[lits2$q301a == \"Disagree\"] <- \"Disagree\"\nlits2$q301a_rec[lits2$q301a == \"Neither disagree nor agree\"] <- \"Neither nor\"\nlits2$q301a_rec[lits2$q301a == \"Dont know\"] <- \"Dont know\"\n# set levels\nlits2$q301a_rec <- factor(lits2$q301a_rec, levels=c(\"Agree\",\"Neither nor\",\"Disagree\",\"Dont know\"))\n######\n# Re-set the survey design\nd.df <- svydesign(id = ~SerialID, \n                  weights = ~weight, \n                  data = lits2)\n##\nt2 <- data.frame(prop.table(svytable(~q301a_rec+country, d.df),2)*100)\nt2 <- t2[!is.na(t2$Freq), ]\n##\nggplot(t2, aes(x=country, y=Freq, fill=q301a_rec)) + \n  geom_bar(stat=\"identity\") + \n  theme(legend.position=\"top\") + \n  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))\n```\n\n### Share agreeing\n\n```{rshareplot, warning=FALSE, message=FALSE, cache=TRUE}\n# Freq table\n## as data.frame of relative shares\nt3 <- subset(t2, q301a_rec %in% 'Agree')\nt3$Freq <- round(t3$Freq,1)\n# plot\nggplot(t3, aes(x=reorder(country, Freq), y=Freq,label=Freq)) + \n  geom_bar(stat=\"identity\", position=\"dodge\", fill=\"cadetblue\") + \n  coord_flip(ylim=c(0,100)) + geom_text(posistion=position_dodge(), hjust=-0.1)\n```",
    "created" : 1409896081884.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2171170960",
    "id" : "9958B731",
    "lastKnownWriteTime" : 1409908193,
    "path" : "~/workspace/luntti/R/survey.Rmd",
    "project_path" : "R/survey.Rmd",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}